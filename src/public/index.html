<!DOCTYPE html>
<html>
  <head>
    <title>template_microservice - index.html</title>
    <link rel="stylesheet" href="/css/template_microservice.css" type="text/css">
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://unpkg.com/vue"></script>

  </head>
  <body>

    <ul id="todo-list">
      <list-item v-for="item in todoList" v-bind:todo="item" v-bind:key="item._id">
    </ul>

    <script>

    /**
     * Represents an editor for the description of an entry within a To-Do list.
     */
    var TodoEditor = Vue.extend({
      props: ['todo'],
      template: `<input type="text" ref="input" v-model="todo.text"
                    @keyup.esc="cancelEdit" @keyup.enter="saveText" />`,
      data: function() {
        return {
          textMemento: this.todo.text
        };
      },
      methods: {
        cancelEdit: function(event) {
          this.todo.text = this.textMemento;
          this.$emit("editCancelled");
        },
        saveText: function(event) {
          // TODO: make an API call to save 'todo.text'
          this.$emit("textSaved");
        }
      },
      mounted: function() {
        this.$refs.input.focus();
      }
    });



    /**
     * Represents an entry within a To-Do list as a checkbox and a description
     * of the action to be performed.
     */
    var TodoEntry = Vue.extend({
      props: ['todo'],
      template: `
      <div>
        <input type="checkbox" v-model="todo.completed" @change="completeTodo">
        <label class="text" for="checkbox">{{ todo.text }}</label>
      </div>`,

      methods: {
        completeTodo: function(event) {
          // TODO: make an API call to complete the todo
        }
      }
    });


    /**
     * An abstaction over the contents of an
     */
    var ListItem = Vue.component('list-item', {
      props: ['todo'],
      template: `
      <li @dblclick="showEditor">
        <component v-bind:is="currentView" v-bind:todo="todo"
          @textSaved="showEntry" @editCancelled="showEntry">
        </component>
      </li>`,
      data: function() {
        return {
          currentView: 'entry'
        };
      },
      methods: {
        showEditor: function() {
          this.currentView = "editor";
        },
        showEntry: function() {
          this.currentView = "entry";
        }
      },
      components: {
        entry: TodoEntry,
        editor: TodoEditor
      }
    });

    /**
     * Initializes the Model-View at rhe DOM element identified by "#todo-list"
     */
    var app = new Vue({
      el: '#todo-list',
      data: {
        todoList: []
      },
      beforeCreate: function() {
        $.ajax({
          url: '/read-them-all'
        }).done(function(data) {
          app.todoList = JSON.parse(data);
        });
      }
    });

    </script>

  </body>
</html>
