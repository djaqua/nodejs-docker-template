<!DOCTYPE html>
<html>
  <head>
    <title>template_microservice - index.html</title>
    <link rel="stylesheet" href="/css/template_microservice.css" type="text/css">
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://unpkg.com/vue"></script>

  </head>
  <body>

    <div id="todo-list">
      <prototype-item @item-persisted="fetchData"></prototype-item>
      <ul>
        <list-item v-for="item in todoList" v-bind:todo="item" v-bind:key="item._id">
      </ul>
    </div>

    <script>

    const DEFAULT_PROTOTYPE_ITEM_TEXT = '';

    /**
     * Represents an editor for the description of an entry within a To-Do list.
     */
    var TodoEditor = Vue.extend({
      props: ['todo'],
      template: `<input type="text" ref="input" v-model="todo.text"
                    @keyup.esc="cancelEdit" @keyup.enter="saveText" />`,
      data: function() {
        return {
          textMemento: this.todo.text
        };
      },
      methods: {
        cancelEdit: function(event) {
          this.todo.text = this.textMemento;
          this.$emit("edit-cancelled");
        },
        saveText: function(event) {
          var self = this;
          // TODO: make an API call to save 'todo.text'\

          $.ajax({
            url: `/updateText/${self.todo._id}/${self.todo.text}`,
            type: 'PUT',
            dataType: 'json', // what is expected back from the server

          }).done(function(data) {
              self.$emit("text-saved");
          }).fail(function(error){
            console.log(error.responseText);
            self.$emit("text-not-saved");
          });
        }
      },
      mounted: function() {
        this.$refs.input.focus();
      }
    });



    /**
     * Represents an entry within a To-Do list as a checkbox and a description
     * of the action to be performed.
     */
    var TodoEntry = Vue.extend({
      props: ['todo'],
      template: `
      <div>
        <input disabled v-if="todo.completed" type="checkbox" v-model="todo.completed" @change="completeTodo">
        <input v-else type="checkbox" v-model="todo.completed" @change="completeTodo">
        <label class="text" for="checkbox">{{ todo.text }}</label>
      </div>`,

      methods: {

        completeTodo: function(event) {
          var self = this;
          $.ajax({
            url: `/complete/${self.todo._id}`,
            type: 'PUT',
            dataType: 'json', // what is expected back from the server

          }).done(function(data) {
              self.$emit("todo-completed");
          }).fail(function(error){
            console.log(error.responseText);
            self.$emit("todo-not-completed");
          });
        }
      }
    });


    Vue.component('prototype-item', {
      template: `<input type="text" v-model="text" @keyup.enter="persistEntry" @keyup.esc="cancelEntry" />`,
      data: function() {
        return {
          text: DEFAULT_PROTOTYPE_ITEM_TEXT
        };
      },
      methods: {
        cancelEntry: function() {
          this.text = DEFAULT_PROTOTYPE_ITEM_TEXT;
          this.$emit("entry-cancelled");
        },
        persistEntry: function() {
          var self = this;
          $.ajax({
            url: `/create/${self.text}`,
            type: 'POST',
            dataType: 'json'
          }).done(function(data) {
            self.text = DEFAULT_PROTOTYPE_ITEM_TEXT;
            self.$emit("item-persisted");
          }).fail(function(error) {
            self.$emit("item-not-persisted");
          });
        }
      }

    });

    /**
     * An abstaction over the contents of an
     */
    Vue.component('list-item', {
      props: ['todo'],
      template: `
      <li @dblclick="showEditor">
        <component v-bind:is="currentView" v-bind:todo="todo"
          @text-saved="showEntry" @edit-cancelled="showEntry" @text-not-saved="handleError">
        </component>
      </li>`,
      data: function() {
        return {
          currentView: 'entry'
        };
      },
      methods: {
        showEditor: function() {
          this.currentView = "editor";
        },
        showEntry: function() {
          this.currentView = "entry";
        },
        handleError: function() {
          alert("There was an error; check the console for details.");
        }
      },
      components: {
        entry: TodoEntry,
        editor: TodoEditor
      }
    });

    /**
     * Initializes the Model-View at rhe DOM element identified by "#todo-list"
     */
    var app = new Vue({
      el: '#todo-list',
      data: {
        todoList: []
      },

      mounted: function() {
        this.fetchData();
      },

      methods: {
        fetchData: function() {
          var self = this;
          $.ajax({
            url: '/all'
          }).done(function(data) {
            self.todoList = JSON.parse(data);
          });
        }
      }
    });

    </script>

  </body>
</html>
